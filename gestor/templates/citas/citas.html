

{% extends 'base.html' %}

{% block title %} | Citas {% endblock title %}

{% block content %}
<div class="container mt-5">

  <!-- TÃ­tulo principal -->
  <div class="text-center mb-4">
    <h1 class="fw-bold">
      <i class="bi bi-calendar3-event me-2"></i> Citas de: {{ mes }}
    </h1>
  </div>

   <!-- Controles superiores -->
  <div class="row mb-4 justify-content-center">
    <div class="col-12 col-md-10">
      <div class="d-flex flex-column flex-md-row align-items-center justify-content-between gap-3">

        <!-- Botones principales -->
        <div class="d-flex flex-row flex-wrap gap-2 justify-content-center align-items-center">
          <button class="btn btn-primary d-flex align-items-center" data-bs-toggle="modal" data-bs-target="#modalAgregarCita">
                <i class="bi bi-plus-circle fs-5 me-2"></i> <span> Cita</span>
            </button>
          <a class="btn btn-secondary d-flex align-items-center" href="/citas/">
            <i class="bi bi-arrow-clockwise me-2"></i> Restablecer
          </a>
        </div>
        {% if user.groups.all.0.name in 'doctor nutricionista fisioterapeuta' %}
        <!-- Resumen -->
        <div class="text-center text-md-start">
          <div class="fw-semibold">Semana: <span class="text-primary">{{ semana }}</span>  Citas: <span class="text-success">{{ conteocitas }}</span></div>
        </div>
        {% endif %}
        <!-- Filtro por semana -->
        <div class="col-12 col-md-auto">
        <div class="row g-2 align-items-center justify-content-center justify-content-md-start">

            <!-- Selector de semana -->
            <div class="col-12 col-sm-auto">
            <input type="week" name="week" class="form-control" />
            </div>

            <!-- BotÃ³n buscar -->
            <div class="col-12 col-sm-auto">
            <button id="week" class="btn btn-outline-success d-flex align-items-center w-100" onclick="buscarsemana()">
                <i class="bi bi-search me-2"></i> Buscar
            </button>
            </div>

  </div>
</div>


      </div>
    </div>
  </div>




  {% if user.groups.all.0.name in 'doctor nutricionista fisioterapeuta' %}
     <!-- Tabla de horarios -->
  <div class="desktop-table">
    <div class="table-responsive" style="overflow-x: auto;">
        <table class="table table-bordered text-center align-middle mb-0" style="min-width: 700px; table-layout: fixed;">
            <thead class="table-light">
            <tr>
                <th style="width: 14%;">Hora/DÃ­a</th>
                <th style="width: 17%;">Lunes: {{ fechalunes }}</th>
                <th style="width: 17%;">Martes: {{ fechamartes }}</th>
                <th style="width: 17%;">MiÃ©rcoles: {{ fechamiercoles }}</th>
                <th style="width: 17%;">Jueves: {{ fechajueves }}</th>
                <th style="width: 17%;">Viernes: {{ fechaviernes }}</th>
            </tr>
            </thead>
            <tbody>
            {% for horario, fila in horarios_citas %}
            <tr style="height: 50px;">
                <td class="fw-semibold small">{{ horario }}</td>
                {% for cita in fila %}
                <td style="height: 50px; vertical-align: middle;">
                {% if cita == 2 %}
                <span class="d-inline-block text-success bg-success bg-opacity-10 rounded px-2 py-1 small fw-semibold">
                    Disponible
                </span>
                {% else %}
                <button
                    type="button" 
                    class="btn btn-appointment btn-sm"
                    data-bs-toggle="modal" 
                    data-bs-target="#modalCita"
                    data-id="{{ cita.idcita }}"
                    data-nombre="{{ cita.paciente.nombre }}"
                    data-fechacita="{{ cita.fechacita }}"
                    data-horacita="{{ cita.horacita }}"
                    data-observaciones="{{ cita.observaciones }}"
                    data-doctor="{{ cita.doctor.nombre }}">
                    {{ cita.paciente.nombre|truncatechars:20 }}
                </button>
                {% endif %}
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
  </div>

      <!-- Vista Mobile - Tarjetas por dÃ­a -->
  <div class="mobile-cards">
      <!-- Lunes -->
      <div class="day-card">
          <div class="day-header">
              ðŸ“… Lunes: {{ fechalunes }}
          </div>
          {% for horario, fila in horarios_citas %}
          <div class="time-slot">
              <span class="time-label">{{ horario }}</span>
              <div class="appointment-content">
                  {% if fila.0 == 2 %}
                  <span class="available-badge">Disponible</span>
                  {% else %}
                  <button class="btn appointment-btn" 
                          data-bs-toggle="modal" data-bs-target="#modalCita"
                          data-id="{{ fila.0.idcita }}"
                          data-nombre="{{ fila.0.paciente.nombre }}"
                          data-fechacita="{{ fila.0.fechacita }}"
                          data-horacita="{{ fila.0.horacita }}"
                          data-observaciones="{{ fila.0.observaciones }}"
                          data-doctor="{{ fila.0.doctor.nombre }}">
                      {{ fila.0.paciente.nombre|truncatechars:25 }}
                  </button>
                  {% endif %}
              </div>
          </div>
          {% endfor %}
      </div>

      <!-- Martes -->
      <div class="day-card">
          <div class="day-header">
              ðŸ“… Martes: {{ fechamartes }}
          </div>
          {% for horario, fila in horarios_citas %}
          <div class="time-slot">
              <span class="time-label">{{ horario }}</span>
              <div class="appointment-content">
                  {% if fila.1 == 2 %}
                  <span class="available-badge">Disponible</span>
                  {% else %}
                  <button class="btn appointment-btn" 
                          data-bs-toggle="modal" data-bs-target="#modalCita"
                          data-id="{{ fila.1.idcita }}"
                          data-nombre="{{ fila.1.paciente.nombre }}"
                          data-fechacita="{{ fila.1.fechacita }}"
                          data-horacita="{{ fila.1.horacita }}"
                          data-observaciones="{{ fila.1.observaciones }}">
                      {{ fila.1.paciente.nombre|truncatechars:25 }}
                  </button>
                  {% endif %}
              </div>
          </div>
          {% endfor %}
      </div>

      <!-- MiÃ©rcoles -->
      <div class="day-card">
          <div class="day-header">
              ðŸ“… MiÃ©rcoles: {{ fechamiercoles }}
          </div>
          {% for horario, fila in horarios_citas %}
          <div class="time-slot">
              <span class="time-label">{{ horario }}</span>
              <div class="appointment-content">
                  {% if fila.2 == 2 %}
                  <span class="available-badge">Disponible</span>
                  {% else %}
                  <button class="btn appointment-btn" 
                          data-bs-toggle="modal" data-bs-target="#modalCita"
                          data-id="{{ fila.2.idcita }}"
                          data-nombre="{{ fila.2.paciente.nombre }}"
                          data-fechacita="{{ fila.2.fechacita }}"
                          data-horacita="{{ fila.2.horacita }}"
                          data-observaciones="{{ fila.2.observaciones }}">
                      {{ fila.2.paciente.nombre|truncatechars:25 }}
                  </button>
                  {% endif %}
              </div>
          </div>
          {% endfor %}
      </div>

      <!-- Jueves -->
      <div class="day-card">
          <div class="day-header">
              ðŸ“… Jueves: {{ fechajueves }}
          </div>
          {% for horario, fila in horarios_citas %}
          <div class="time-slot">
              <span class="time-label">{{ horario }}</span>
              <div class="appointment-content">
                  {% if fila.3 == 2 %}
                  <span class="available-badge">Disponible</span>
                  {% else %}
                  <button class="btn appointment-btn" 
                          data-bs-toggle="modal" data-bs-target="#modalCita"
                          data-id="{{ fila.3.idcita }}"
                          data-nombre="{{ fila.3.paciente.nombre }}"
                          data-fechacita="{{ fila.3.fechacita }}"
                          data-horacita="{{ fila.3.horacita }}"
                          data-observaciones="{{ fila.3.observaciones }}">
                      {{ fila.3.paciente.nombre|truncatechars:25 }}
                  </button>
                  {% endif %}
              </div>
          </div>
          {% endfor %}
      </div>

      <!-- Viernes -->
      <div class="day-card">
          <div class="day-header">
              ðŸ“… Viernes: {{ fechaviernes }}
          </div>
          {% for horario, fila in horarios_citas %}
          <div class="time-slot">
              <span class="time-label">{{ horario }}</span>
              <div class="appointment-content">
                  {% if fila.4 == 2 %}
                  <span class="available-badge">Disponible</span>
                  {% else %}
                  <button class="btn appointment-btn" 
                          data-bs-toggle="modal" data-bs-target="#modalCita"
                          data-id="{{ fila.4.idcita }}"
                          data-nombre="{{ fila.4.paciente.nombre }}"
                          data-fechacita="{{ fila.4.fechacita }}"
                          data-horacita="{{ fila.4.horacita }}"
                          data-observaciones="{{ fila.4.observaciones }}">
                      {{ fila.4.paciente.nombre|truncatechars:25 }}
                  </button>
                  {% endif %}
              </div>
          </div>
          {% endfor %}
      </div>
  </div>
  {% elif user.groups.all.0.name == 'administrador' %}
    <!-- Vista tipo Cards para mÃ³viles -->
    <div class="d-md-none">
        {% for cita in citas %}
        <div class="card mb-3 shadow-sm">
            <div class="card-body">
                <h5 class="card-title fw-bold">Consulta #{{ cita.idcita }}</h5>
                <p class="mb-1"><strong>Paciente:</strong> {{ cita.paciente.nombre }}</p>
                <p class="mb-1"><strong>Fecha:</strong> {{ cita.fechacita|date:"d/m/Y" }}</p>
                <p class="mb-1"><strong>Hora:</strong> {{ cita.horacita }}</p>
                <p class="mb-1"><strong>Doctor:</strong> ${{ cita.doctor.nombre }}</p>
                <p class="mb-2"><strong>Observaciones:</strong> {{ cita.observaciones|default:"Sin observaciones" }}</p>
                <div class="d-flex flex-wrap gap-2">
                    
                    <button class="btn btn-sm btn-info text-white"
                            data-bs-toggle="modal"
                            data-bs-target="#modalCita"
                            data-id="{{ cita.idcita }}"
                            data-nombre="{{ cita.paciente.nombre }}"
                            data-fechacita="{{ cita.fechacita }}"
                            data-horacita="{{ cita.horacita }}"
                            data-observaciones="{{ cita.observaciones }}"
                            data-doctor="{{ cita.doctor.nombre }}">
                        <i class="bi bi-eye"></i> Detalles
                    </button>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="text-center">No hay citas registradas.</div>
        {% endfor %}
        {% include "paginacion.html" %}
    </div>

    <!-- Tabla solo visible en escritorio -->
    <div class="tbl_container d-none d-md-block">
        <div class="table-responsive">
            <table class="table table-bordered table-hover align-middle text-center">
                <thead class="table-dark">
                    <tr>
                        <th>NÃºmero</th>
                        <th>Paciente</th>
                        <th>Fecha</th>
                        <th>Hora</th>
                        <th>Observaciones</th>
                        <th>Doctor</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for cita in citas %}
                    <tr>
                        <td>{{ cita.idcita }}</td>
                        <td>{{ cita.paciente.nombre|truncatechars:20 }}</td>
                        <td>{{ cita.fechacita }}</td>
                        <td>{{ cita.horacita }}</td>
                        <td>{{ cita.observaciones|truncatechars:30 }}</td>
                        <td>{{ cita.doctor.nombre }}</td>
                        
                        <td>
                            <div class="d-flex flex-wrap justify-content-center gap-1">
                                <button
                                    type="button" 
                                    class="btn btn-info btn-sm text-white"
                                    data-bs-toggle="modal" 
                                    data-bs-target="#modalCita"
                                    data-id="{{ cita.idcita }}"
                                    data-nombre="{{ cita.paciente.nombre }}"
                                    data-fechacita="{{ cita.fechacita }}"
                                    data-horacita="{{ cita.horacita }}"
                                    data-observaciones="{{ cita.observaciones }}"
                                    data-doctor="{{ cita.doctor.nombre }}">
                                    Detalles
                                </button>
                            </div> 
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7">No hay citas registradas.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% include "paginacion.html" %}
    </div>
  {% endif %}

  <!-- Modal para agregar cita -->
<div class="modal fade" id="modalAgregarCita" tabindex="-1" aria-labelledby="modalAgregarCitaLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-md">
    <div class="modal-content shadow">

      <!-- Header -->
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="modalAgregarConsultaLabel">
          <i class="bi bi-person-plus-fill me-2"></i>Nueva cita
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>

      <!-- Formulario -->
      <form method="get" action="/agregarcita/">
        <div class="modal-body">
          <div class="row gy-3">
            <div class="col-12 d-flex align-items-start">
              <i class="bi bi-person-fill-add fs-4 text-info me-3 mt-1"></i>
              <div class="w-100">
                <h6 class="mb-1">Seleccionar paciente</h6>
                <select class="form-select" name="paciente_id" required>
                  <option value="" disabled selected>Pacientes</option>
                  {% for paciente in pacientes %}
                    <option value="{{ paciente.idpaciente }}">{{ paciente.nombre }}</option>
                  {% endfor %}
                </select>
                <input type="hidden" name="paciente_nombre" id="pacienteNombreInput">
              </div>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <div class="modal-footer d-flex flex-wrap gap-2 justify-content-between">
          <div class="d-flex flex-wrap gap-2">
            
            <button type="submit" class="btn btn-success">
              <i class="bi bi-arrow-right-circle me-1"></i> Siguiente
            </button>
          </div>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle me-1"></i> Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

 <!-- Modal para ver cita -->
<div class="modal fade" id="modalCita" tabindex="-1" aria-labelledby="modalCitaLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content shadow-lg rounded-4 border-0">

      <!-- Header -->
      <div class="modal-header bg-primary text-white rounded-top-4">
        <h5 class="modal-title" id="modalCitaLabel">
          <i class="bi bi-calendar-check-fill me-2"></i> Detalles de la Cita
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>

      <!-- Body -->
      <div class="modal-body px-4 py-4">
        <div class="row gy-4">

          <!-- Paciente -->
          <div class="col-md-6">
            <div class="d-flex align-items-start">
              <i class="bi bi-person-fill fs-4 text-primary me-3"></i>
              <div>
                <h6 class="mb-1">Paciente</h6>
                <p id="citaNombre" class="text-muted mb-0"></p>
              </div>
            </div>
          </div>

          <!-- Doctor -->
          <div class="col-md-6">
            <div class="d-flex align-items-start">
              <i class="bi bi-person-circle fs-4 text-info me-3"></i>
              <div>
                <h6 class="mb-1">Doctor</h6>
                <p id="citaDoctor" class="text-muted mb-0"></p>
              </div>
            </div>
          </div>

          <!-- Fecha -->
          <div class="col-md-6">
            <div class="d-flex align-items-start">
              <i class="bi bi-calendar-event-fill fs-4 text-success me-3"></i>
              <div>
                <h6 class="mb-1">Fecha</h6>
                <p id="citaFechacita" class="text-muted mb-0"></p>
              </div>
            </div>
          </div>

          <!-- Hora -->
          <div class="col-md-6">
            <div class="d-flex align-items-start">
              <i class="bi bi-clock-fill fs-4 text-warning me-3"></i>
              <div>
                <h6 class="mb-1">Hora</h6>
                <p id="citaHoracita" class="text-muted mb-0"></p>
              </div>
            </div>
          </div>

          <!-- Observaciones -->
          <div class="col-12">
            <div class="d-flex align-items-start">
              <i class="bi bi-chat-left-text-fill fs-4 text-secondary me-3"></i>
              <div>
                <h6 class="mb-1">Observaciones</h6>
                <p id="citaObservaciones" class="text-muted mb-0"></p>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- Footer -->
      <div class="modal-footer bg-light rounded-bottom-4 border-top-0 d-flex justify-content-between flex-wrap gap-2">
        <div class="d-flex flex-wrap gap-2">
          <a id="btnEditarCita" class="btn btn-outline-success">
            <i class="bi bi-pencil-square me-1"></i> Editar
          </a>
          <button 
            class="btn btn-outline-danger"
            data-bs-toggle="modal"
            data-bs-target="#modalConfirmarEliminarCita"
            data-bs-dismiss="modal">
            <i class="bi bi-trash me-1"></i> Eliminar
          </button>
        </div>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-1"></i> Cerrar
        </button>
      </div>

    </div>
  </div>
</div>


  <!-- Modal Confirmar EliminaciÃ³n -->
<div class="modal fade" id="modalConfirmarEliminarCita" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Â¿Eliminar Cita?</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Â¿EstÃ¡s seguro de eliminar esta Cita?</p>
            </div>
            <div class="modal-footer">
                <form id="formEliminarCita" method="post">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger btn-sm">SÃ­, eliminar</button>
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
                </form>
            </div>
        </div>
    </div>
</div>
</div>

<script>
  // Asignar nombre al paciente automÃ¡ticamente
  document.addEventListener('DOMContentLoaded', function () {
    const select = document.querySelector('select[name="paciente_id"]');
    const input = document.getElementById('pacienteNombreInput');

    select.addEventListener('change', function () {
      const nombre = select.options[select.selectedIndex].text;
      input.value = nombre;
    });
  });

  // FunciÃ³n para buscar por semana
  function buscarsemana() {
    const weekInput = document.querySelector('input[name="week"]');
    const week = weekInput.value;

    if (!week) {
      swal({
        title: "Â¡Campo vacÃ­o!",
        text: "Seleccione una semana.",
        timer: 2000,
        icon: "warning",
        buttons: false
      });
      return;
    }

    const [ano, semana] = week.split('-W');
    if (!ano || !semana) {
      swal({
        title: "Â¡Error!",
        text: "Formato de semana invÃ¡lido.",
        timer: 2000,
        icon: "error",
        buttons: false
      });
      return;
    }

    // Redirige a la vista en Django
    location.href = `/buscarsemana/${ano}/${semana}`;
  }
</script>

{% if messages %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        {% for message in messages %}
            darkModeSwal({
                icon: "{% if message.tags == 'success' %}success{% elif message.tags == 'error' %}error{% elif message.tags == 'warning' %}warning{% else %}info{% endif %}",
                title: "{{ message|escapejs }}",
                timer: 3000
            });
        {% endfor %}
    });
</script>
{% endif %}
{% endblock content %}
