{% extends 'index.html' %}

{% block title %} | Pacientes {% endblock title %}

{% block content %}
{% load static %}

<div class="container-fluid py-1">
  <div class="text-center mb-3">
    <h2 class="fw-bold mb-0">Pacientes</h2>
  </div>

  <!-- Controles y Búsqueda -->
  <div class="row g-3 align-items-center justify-content-between mb-3">
    
    <!-- Botones -->
    <div class="col-12 col-md-auto d-flex flex-wrap gap-2 justify-content-center justify-content-md-start">
      <a class="btn btn-primary" href="/agregarpaciente/">
        <i class="bi bi-plus-circle"></i> Paciente
      </a>
      <a class="btn btn-secondary" href="/pacientes/">
        <i class="bi bi-arrow-clockwise"></i> Restablecer
      </a>
    </div>

    <!-- Formulario de búsqueda -->
    <div class="col-12 col-md">
      <form method="get" class="row g-2 justify-content-center justify-content-md-end">
        
        <!-- Filtro -->
        <div class="col-6 col-sm-4 col-md-3 col-lg-2">
          <select class="form-select form-select-sm" name="filtro">
            <option value="nombre" {% if filtro == "nombre" %}selected{% endif %}>Nombre</option>
            <option value="telefono" {% if filtro == "telefono" %}selected{% endif %}>Teléfono</option>
            <option value="sexo" {% if filtro == "sexo" %}selected{% endif %}>Sexo</option>
          </select>
        </div>

        <!-- Campo de búsqueda -->
        <div class="col-6 col-sm-4 col-md-3 col-lg-2">
          <input required type="text" class="form-control form-control-sm" name="buscar" placeholder="Buscar..." value="{{ buscar }}">
        </div>

        <!-- Botón Buscar -->
        <div class="col-12 col-sm-4 col-md-auto">
          <button type="submit" class="btn btn-success btn-sm w-100 d-flex align-items-center justify-content-center">
            <i class="bi bi-search fs-5 me-2"></i> <span>Buscar</span>
          </button>
        </div>
      </form>
    </div>

  </div>

<!-- Vista tipo cards para móviles -->
<div class="d-md-none">
    {% for paciente in entity %}
    <div class="card mb-3 shadow-sm">
        <div class="card-body">
            <h5 class="card-title fw-bold">{{ paciente.nombre }}</h5>
            <p class="card-text mb-1"><strong>Fecha nacimiento:</strong> {{ paciente.fecha_nacimiento }}</p>
            <p class="card-text mb-2"><strong>Teléfono:</strong> {{ paciente.telefono }}</p>
            <p class="card-text mb-2"><strong>Usuario:</strong> 
                {% if paciente.usuario %}
                    {{ paciente.usuario.username }}
                {% else %}
                    Sin usuario asignado
                {% endif %}
            </p>
            <button class="btn btn-sm btn-info text-white"
                    data-bs-toggle="modal"
                    data-bs-target="#modalPaciente"
                    data-id="{{ paciente.idpaciente }}"
                    data-nombre="{{ paciente.nombre }}"
                    data-fecha="{{ paciente.fecha_nacimiento }}"
                    data-telefono="{{ paciente.telefono }}"
                    data-sexo="{{ paciente.sexo }}"
                    data-user="{% if paciente.usuario %}{{ paciente.usuario.username }}{% endif %}">
                Detalles
            </button>
        </div>
    </div>
    {% empty %}
    <div class="text-center">No hay pacientes registrados.</div>
    {% endfor %}
</div>

    <!-- Tabla de Pacientes -->
 <div class="table-responsive d-none d-md-block">
    <table class="table table-bordered table-hover align-middle text-center custom-table-compact">
        <thead class="table-dark">
            <tr>
                <th class="py-2">Numero</th>
                <th class="py-2">Nombre</th>
                <th class="py-2">Fecha nacimiento</th>
                <th class="py-2">Teléfono</th>
                <th class="py-2">Sexo</th>
                <th class="py-2">Usuario</th>
                <th class="py-2">Acciones</th>
            </tr>
        </thead>
        <tbody >
            {% for paciente in entity %}
            <tr class="table-row-compact">
                <td class="py-2">{{ paciente.idpaciente }}</td>
                <td class="py-2">{{ paciente.nombre }}</td>
                <td class="py-2">{{ paciente.fecha_nacimiento }}</td>
                <td class="py-2">{{ paciente.telefono }}</td>
                <td class="py-2">
                    {% if paciente.sexo == 'M' %}
                        <span class="badge bg-primary">Masculino</span>
                    {% elif paciente.sexo == 'F' %}
                        <span class="badge bg-danger">Femenino</span>
                    {% else %}
                        <span class="badge bg-secondary">No especificado</span>
                    {% endif %}
                </td>
                <td class="py-2">
                {% if paciente.usuario %}
                    {{ paciente.usuario.username }}
                {% else %}
                    Sin usuario asignado
                {% endif %}
            </td>
                <td class="py-2">
                    <button class="btn btn-sm btn-info text-white px-3 py-1"
                            data-bs-toggle="modal"
                            data-bs-target="#modalPaciente"
                            data-id="{{ paciente.idpaciente }}"
                            data-nombre="{{ paciente.nombre }}"
                            data-fecha="{{ paciente.fecha_nacimiento }}"
                            data-telefono="{{ paciente.telefono }}"
                            data-sexo="{{ paciente.sexo }}"
                            data-user="{% if paciente.usuario %}{{ paciente.usuario.username }}{% endif %}">
                        <i class="fas fa-eye me-1"></i>Detalles
                    </button>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="4" class="py-3 text-muted">
                    <i class="fas fa-users me-2"></i>No hay pacientes registrados.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
    {% include "paginacion.html" %}
</div>
 
<!-- Modal Detalles Paciente -->
<div class="modal fade" id="modalPaciente" tabindex="-1" aria-labelledby="modalPacienteLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content shadow">

            <!-- Header -->
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalPacienteLabel">
                    <i class="bi bi-person-lines-fill me-2"></i> Información del Paciente
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>

            <!-- Body -->
            <div class="modal-body">
                <div class="row gy-3">
                    <div class="col-12 col-md-6 d-flex align-items-start">
                        <i class="bi bi-person-fill fs-4 text-primary me-3 mt-1"></i>
                        <div>
                            <h6 class="mb-0">Nombre</h6>
                            <p class="text-muted mb-0" id="pacienteNombre"></p>
                        </div>
                    </div>
                    <div class="col-12 col-md-6 d-flex align-items-start">
                        <i class="bi bi-calendar-event-fill fs-4 text-success me-3 mt-1"></i>
                        <div>
                            <h6 class="mb-0">Fecha de nacimiento</h6>
                            <p class="text-muted mb-0" id="pacienteFechaNacimiento"></p>
                        </div>
                    </div>
                    <div class="col-12 col-md-6 d-flex align-items-start">
                        <i class="bi bi-hourglass-split fs-4 text-warning me-3 mt-1"></i>
                        <div>
                            <h6 class="mb-0">Edad</h6>
                            <p class="text-muted mb-0"><span id="pacienteEdad"></span> años</p>
                        </div>
                    </div>
                    <div class="col-12 col-md-6 d-flex align-items-start">
                        <i class="bi bi-telephone-fill fs-4 text-danger me-3 mt-1"></i>
                        <div>
                            <h6 class="mb-0">Teléfono</h6>
                            <p class="text-muted mb-0" id="pacienteTelefono"></p>
                        </div>
                    </div>
                    <div class="col-12 col-md-6 d-flex align-items-start">
                        <i class="bi bi-person-fill fs-4 text-info me-3 mt-1"></i>
                        <div>
                            <h6 class="mb-0">Sexo</h6>
                            <p class="text-muted mb-0" id="pacienteSexo"></p>   
                        </div>
                    </div>
                    <div class="col-12 col-md-6 d-flex align-items-start">
                        <i class="bi bi-person-circle fs-4 text-secondary me-3 mt-1"></i>
                        <div>
                            <h6 class="mb-0">Usuario</h6>
                            <p class="text-muted mb-0" id="pacienteUsuario">
                                {% if paciente.usuario %}
                                    {{ paciente.usuario.username }}
                                {% else %}
                                    No asignado
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="modal-footer d-flex flex-wrap gap-2 justify-content-between">
                <div class="d-flex flex-wrap gap-2">
                    <a id="btnEditarPaciente" class="btn btn-outline-primary">
                        <i class="bi bi-pencil-square me-1"></i> Editar
                    </a>
                    <a id="btnHistorial" class="btn btn-outline-info text-dark">
                        <i class="bi bi-journal-text me-1"></i> Historial
                    </a>
                    <button 
                    class="btn btn-outline-danger"
                    data-bs-toggle="modal"
                    data-bs-target="#modalConfirmarEliminarPaciente"
                    data-bs-dismiss="modal">
                    <i class="bi bi-trash"></i> Eliminar
                    </button>
                </div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i> Cerrar
                </button>
            </div>

        </div>
    </div>
</div>
<!-- Modal Confirmar Eliminación -->
<div class="modal fade" id="modalConfirmarEliminarPaciente" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">¿Eliminar Paciente?</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de eliminar esta Paciente?</p>
            </div>
            <div class="modal-footer">
                <form id="formEliminarPaciente" method="post">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger btn-sm">Sí, eliminar</button>
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% if messages %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        {% for message in messages %}
            darkModeSwal({
                icon: "{% if message.tags == 'success' %}success{% elif message.tags == 'error' %}error{% elif message.tags == 'warning' %}warning{% else %}info{% endif %}",
                title: "{{ message|escapejs }}",
                timer: 3000
            });
        {% endfor %}
    });
</script>
{% endif %}
{% endblock content %}
